const remSize=parseInt(getComputedStyle(document.documentElement).fontSize);const playPanel=document.getElementById("playPanel");const infoPanel=document.getElementById("infoPanel");const countPanel=document.getElementById("countPanel");const scorePanel=document.getElementById("scorePanel");const startButton=document.getElementById("startButton");const romaNode=document.getElementById("roma");const japaneseNode=document.getElementById("japanese");const gradeOption=document.getElementById("gradeOption");const aa=document.getElementById("aa");const gameTime=120;const tmpCanvas=document.createElement("canvas");const mode=document.getElementById("mode");let typeTimer;const bgm=new Audio("mp3/bgm.mp3");bgm.volume=0.3;bgm.loop=true;let typeIndex=0;let errorCount=0;let normalCount=0;let solveCount=0;let allProblems=[];let problems=[];let englishVoices=[];let guide=false;let keyboardAudio,correctAudio,incorrectAudio,endAudio;loadAudios();const AudioContext=window.AudioContext||window.webkitAudioContext;const audioContext=new AudioContext();const layout104={"default":["{tab} q w e r t y u i o p [ ]","{lock} a s d f g h j k l ;","{shift} z x c v b n m , .","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ",],"shift":["{tab} Q W E R T Y U I O P { }","{lock} A S D F G H J K L :","{shift} Z X C V B N M < >","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ",],};const layout109={"default":["{tab} q w e r t y u i o p","{lock} a s d f g h j k l ;","{shift} z x c v b n m , .","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ",],"shift":["{tab} Q W E R T Y U I O P","{lock} A S D F G H J K L +","{shift} Z X C V B N M < >","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ",],};const keyboardDisplay={"{tab}":"Tab","{lock}":"Caps","{shift}":"Shift","{space}":" ","üåè":"üáØüáµ",};const simpleKeyboard=new SimpleKeyboard.default({layout:layout109,display:keyboardDisplay,onInit:function(){document.getElementById("keyboard").classList.add("d-none");},onKeyPress:function(input){switch(input){case "{esc}":return typeEventKey("Esc");case "{space}":return typeEventKey(" ");case "ÁÑ°Â§âÊèõ":return typeEventKey("NonConvert");case "Â§âÊèõ":return typeEventKey("Convert");case "üåè":if(simpleKeyboard.options.layout==layout109){keyboardDisplay["üåè"]="üá∫üá∏";simpleKeyboard.setOptions({layout:layout104,display:keyboardDisplay,});}else{keyboardDisplay["üåè"]="üáØüáµ";simpleKeyboard.setOptions({layout:layout109,display:keyboardDisplay,});}
break;case "{shift}":case "{lock}":{const shiftToggle=(simpleKeyboard.options.layoutName=="default")?"shift":"default";simpleKeyboard.setOptions({layoutName:shiftToggle});break;}
default:return typeEventKey(input);}},});loadConfig();function loadConfig(){if(localStorage.getItem("darkMode")==1){document.documentElement.dataset.theme="dark";}
if(localStorage.getItem("bgm")!=1){document.getElementById("bgmOn").classList.add("d-none");document.getElementById("bgmOff").classList.remove("d-none");}}
function toggleBGM(){if(localStorage.getItem("bgm")==1){document.getElementById("bgmOn").classList.add("d-none");document.getElementById("bgmOff").classList.remove("d-none");localStorage.setItem("bgm",0);bgm.pause();}else{document.getElementById("bgmOn").classList.remove("d-none");document.getElementById("bgmOff").classList.add("d-none");localStorage.setItem("bgm",1);bgm.play();}}
function toggleKeyboard(){const virtualKeyboardOn=document.getElementById("virtualKeyboardOn");const virtualKeyboardOff=document.getElementById("virtualKeyboardOff");if(virtualKeyboardOn.classList.contains("d-none")){virtualKeyboardOn.classList.remove("d-none");virtualKeyboardOff.classList.add("d-none");document.getElementById("keyboard").classList.remove("d-none");aa.parentNode.style.height=calcAAOuterSize()+"px";resizeFontSize(aa);}else{virtualKeyboardOn.classList.add("d-none");virtualKeyboardOff.classList.remove("d-none");document.getElementById("keyboard").classList.add("d-none");document.getElementById("guideSwitch").checked=false;guide=false;aa.parentNode.style.height=calcAAOuterSize()+"px";resizeFontSize(aa);}}
function toggleGuide(){const virtualKeyboardOn=document.getElementById("virtualKeyboardOn");const virtualKeyboardOff=document.getElementById("virtualKeyboardOff");if(this.checked){virtualKeyboardOn.classList.remove("d-none");virtualKeyboardOff.classList.add("d-none");document.getElementById("keyboard").classList.remove("d-none");aa.parentNode.style.height=calcAAOuterSize()+"px";resizeFontSize(aa);guide=true;}else{virtualKeyboardOn.classList.add("d-none");virtualKeyboardOff.classList.remove("d-none");document.getElementById("keyboard").classList.add("d-none");aa.parentNode.style.height=calcAAOuterSize()+"px";resizeFontSize(aa);guide=false;}}
function toggleDarkMode(){if(localStorage.getItem("darkMode")==1){localStorage.setItem("darkMode",0);delete document.documentElement.dataset.theme;}else{localStorage.setItem("darkMode",1);document.documentElement.dataset.theme="dark";}}
function playAudio(audioBuffer,volume){const audioSource=audioContext.createBufferSource();audioSource.buffer=audioBuffer;if(volume){const gainNode=audioContext.createGain();gainNode.gain.value=volume;gainNode.connect(audioContext.destination);audioSource.connect(gainNode);audioSource.start();}else{audioSource.connect(audioContext.destination);audioSource.start();}}
function unlockAudio(){audioContext.resume();}
function loadAudio(url){return fetch(url).then((response)=>response.arrayBuffer()).then((arrayBuffer)=>{return new Promise((resolve,reject)=>{audioContext.decodeAudioData(arrayBuffer,(audioBuffer)=>{resolve(audioBuffer);},(err)=>{reject(err);});});});}
function loadAudios(){promises=[loadAudio("mp3/keyboard.mp3"),loadAudio("mp3/correct.mp3"),loadAudio("mp3/cat.mp3"),loadAudio("mp3/end.mp3"),];Promise.all(promises).then((audioBuffers)=>{keyboardAudio=audioBuffers[0];correctAudio=audioBuffers[1];incorrectAudio=audioBuffers[2];endAudio=audioBuffers[3];});}
function loadVoices(){const allVoicesObtained=new Promise(function(resolve){let voices=speechSynthesis.getVoices();if(voices.length!==0){resolve(voices);}else{speechSynthesis.addEventListener("voiceschanged",function(){voices=speechSynthesis.getVoices();resolve(voices);});}});allVoicesObtained.then((voices)=>{englishVoices=voices.filter((voice)=>voice.lang=="en-US");});}
loadVoices();function loopVoice(text,n){speechSynthesis.cancel();text=text.replace(/si/g,"shi").replace(/ti/g,"chi").replace(/ni/g,"nee").replace(/juu/g,"jew");const msg=new SpeechSynthesisUtterance(text);msg.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)];msg.lang="en-US";for(let i=0;i<n;i++){speechSynthesis.speak(msg);}}
function loadProblems(){fetch("data/problem.tsv").then(function(response){return response.text();}).then(function(tsv){allProblems=tsv.split("\n").slice(0,-1).map((line)=>{const[en,kuku,ja]=line.split("\t");return{en:en,kuku:kuku,ja:ja};});problems=allProblems.slice(0,9);}).catch(function(err){console.error(err);});}
function fixTypeStyle(currNode,word,sound){removeGuide(currNode);currNode.textContent=word;typeNormal(currNode,sound);}
function appendWord(currNode,word){removeGuide(currNode);const span=document.createElement("span");span.textContent=word;currNode.parentNode.insertBefore(span,currNode.nextSibling);}
function checkTypeStyle(currNode,word,key,romaNode){const ie=["i","e"];const auo=["a","u","o"];const aueo=["a","u","e","o"];const aiueo=["a","i","u","e","o"];const nodes=romaNode.childNodes;const nextNode=nodes[typeIndex+1];let n;if(nextNode){n=nextNode.textContent;}
let p;if(typeIndex!=0){p=nodes[typeIndex-1].textContent;}
let nn;if(nodes[typeIndex+2]){nn=nodes[typeIndex+2].textContent;}
if(key=="k"&&word=="c"&&auo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="c"&&word=="k"&&auo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="h"&&p=="s"&&word=="i"){fixTypeStyle(currNode,key);appendWord(currNode,"i");}else if(key=="i"&&p=="s"&&word=="h"&&n=="i"){fixTypeStyle(currNode,key);if(n)nextNode.remove();}else if(key=="c"&&word=="s"&&ie.includes(n)){fixTypeStyle(currNode,key);}else if(key=="s"&&word=="c"&&ie.includes(n)){fixTypeStyle(currNode,key);}else if(key=="j"&&word=="z"&&n=="i"){fixTypeStyle(currNode,key);}else if(key=="z"&&word=="j"&&n=="i"){fixTypeStyle(currNode,key);}else if(key=="c"&&word=="t"&&n=="i"){fixTypeStyle(currNode,key);appendWord(currNode,"h");}else if(key=="t"&&word=="c"&&n=="h"&&nn=="i"){fixTypeStyle(currNode,key);if(n)nextNode.remove();}else if(key=="s"&&p=="t"&&word=="u"){fixTypeStyle(currNode,key);appendWord(currNode,"u");}else if(key=="u"&&p=="t"&&word=="s"&&n=="u"){fixTypeStyle(currNode,key);if(n)nextNode.remove();}else if(key=="f"&&word=="h"&&n=="u"){fixTypeStyle(currNode,key);}else if(key=="h"&&word=="f"&&n=="u"){fixTypeStyle(currNode,key);}else if(key=="x"&&word=="n"&&n=="n"){fixTypeStyle(currNode,key);}else if(key=="n"&&word=="x"&&n=="n"){fixTypeStyle(currNode,key);}else if(key=="l"&&word=="x"&&aiueo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="x"&&word=="l"&&aiueo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="x"&&word=="l"&&n=="y"&&auo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="h"&&p=="w"&&ie.includes(word)){fixTypeStyle(currNode,key);appendWord(currNode,word);}else if(ie.includes(key)&&p=="w"&&word=="h"&&ie.includes(n)){fixTypeStyle(currNode,key);if(n)nextNode.remove();}else if(key=="h"&&p=="s"&&word=="y"&&aueo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="y"&&p=="s"&&word=="h"&&aueo.includes(n)){fixTypeStyle(currNode,key);}else if(key=="j"&&word=="z"&&n=="y"&&auo.includes(nn)){fixTypeStyle(currNode,key);if(n)nextNode.remove();}else if(key=="z"&&word=="j"&&auo.includes(n)){fixTypeStyle(currNode,key);appendWord(currNode,"y");}else if(key=="j"&&word=="z"&&n=="y"){fixTypeStyle(currNode,key);}else if(auo.includes(key)&&p=="j"&&word=="y"&&auo.includes(n)){fixTypeStyle(currNode,key);if(n)nextNode.remove();}else if(key=="y"&&p=="j"&&auo.includes(word)){fixTypeStyle(currNode,key);appendWord(currNode,n);}else if(key=="z"&&word=="j"&&n=="y"){fixTypeStyle(currNode,key);}else if(key=="t"&&word=="c"&&n=="y"){fixTypeStyle(currNode,key);}else if(key=="c"&&word=="t"&&n=="y"){fixTypeStyle(currNode,key);}else if(key=="t"&&word=="c"&&n=="h"&&aueo.includes(n)){fixTypeStyle(currNode,key);nextNode.textContent="y";}else if(key=="h"&&p=="c"&&word=="y"&&aueo.includes(n)){fixTypeStyle(currNode,key);nextNode.textContent=n;}else if(key=="y"&&p=="c"&&word=="h"&&aueo.includes(n)){fixTypeStyle(currNode,key);nextNode.textContent=n;}else{return false;}
return true;}
function typeNormal(currNode){currNode.classList.remove("d-none");playAudio(keyboardAudio);currNode.style.color="silver";typeIndex+=1;normalCount+=1;}
function underlineSpace(currNode){if(currNode.textContent==" "){currNode.style.removeProperty("text-decoration");}
const nextNode=currNode.nextElementSibling;if(nextNode&&nextNode.textContent==" "){nextNode.style.textDecoration="underline";}}
function nextProblem(){playAudio(correctAudio);typeIndex=0;solveCount+=1;typable();}
function removeGuide(currNode){const prevNode=currNode.previousSiblingElement;if(prevNode){let key=prevNode.textContent;if(key==" ")key="{space}";const button=simpleKeyboard.getButtonElement(key);button.classList.remove("bg-info");}
let key=currNode.textContent;if(key==" ")key="{space}";const button=simpleKeyboard.getButtonElement(key);if(button){button.classList.remove("bg-info");simpleKeyboard.setOptions({layoutName:"default"});}else{const shift=simpleKeyboard.getButtonElement("{shift}");shift.classList.remove("bg-info");}}
function showGuide(currNode){if(guide){let key=currNode.textContent;if(key==" ")key="{space}";const button=simpleKeyboard.getButtonElement(key);if(button){button.classList.add("bg-info");}else{const shift=simpleKeyboard.getButtonElement("{shift}");shift.classList.add("bg-info");}}}
function upKeyEvent(event){switch(event.key){case "Shift":case "CapsLock":if(guide){simpleKeyboard.setOptions({layoutName:"default"});showGuide(romaNode.childNodes[typeIndex]);}}}
function patchEvent(event){if(event.key=="@"&&event.code=="Digit2"){return '"';}else if(event.key=="&"&&event.code=="Digit7"){return "'";}else{return event.key;}}
function typeEvent(event){const key=patchEvent(event);if(key==" "||key=="Spacebar"){event.preventDefault();}
typeEventKey(key);}
function typeEventKey(key){const currNode=romaNode.childNodes[typeIndex];if(key.match(/^[^0-9]$/)){if(key==currNode.textContent){typeNormal(currNode);removeGuide(currNode);underlineSpace(currNode);}else{const state=checkTypeStyle(currNode,currNode.textContent,key,romaNode,);if(!state){playAudio(incorrectAudio,0.3);errorCount+=1;}}
if(typeIndex==romaNode.childNodes.length){nextProblem();}else{showGuide(romaNode.childNodes[typeIndex]);}}else{switch(key){case "NonConvert":[...romaNode.children].forEach((span)=>{span.classList.remove("d-none");});downTime(5);break;case "Convert":{const text=romaNode.textContent;loopVoice(text,1);break;}
case "Shift":case "CapsLock":if(guide){simpleKeyboard.setOptions({layoutName:"shift"});showGuide(romaNode.childNodes[typeIndex]);}
break;case "Escape":case "Esc":replay();break;}}}
function replay(){clearInterval(typeTimer);removeGuide(romaNode.childNodes[typeIndex]);document.removeEventListener("keydown",typeEvent);initTime();countdown();setProblems();typeIndex=normalCount=errorCount=solveCount=0;countPanel.classList.remove("d-none");scorePanel.classList.add("d-none");}
function calcAAOuterSize(){let height=document.documentElement.clientHeight;height-=document.getElementById("headerNav").offsetHeight;height-=document.getElementById("timePanel").offsetHeight;height-=document.getElementById("typePanel").offsetHeight;height-=document.getElementById("keyboard").offsetHeight;return height;}
function resizeFontSize(node){function getTextWidth(text,font){const context=tmpCanvas.getContext("2d");context.font=font;const metrics=context.measureText(text);return metrics.width;}
function getTextRect(text,fontSize,font,lineHeight){const lines=text.split("\n");const fontConfig=fontSize+"px "+font;let maxWidth=0;for(let i=0;i<lines.length;i++){const width=getTextWidth(lines[i],fontConfig);if(maxWidth<width){maxWidth=width;}}
return[maxWidth,fontSize*lines.length*lineHeight];}
function getPaddingRect(style){const width=parseFloat(style.paddingLeft)+
parseFloat(style.paddingRight);const height=parseFloat(style.paddingTop)+
parseFloat(style.paddingBottom);return[width,height];}
const style=getComputedStyle(node);const font=style.fontFamily;const fontSize=parseFloat(style.fontSize);const lineHeight=parseFloat(style.lineHeight)/fontSize;const nodeHeight=calcAAOuterSize();const nodeWidth=infoPanel.clientWidth;const nodeRect=[nodeWidth,nodeHeight];const textRect=getTextRect(node.textContent,fontSize,font,lineHeight);const paddingRect=getPaddingRect(style);const rowFontSize=fontSize*(nodeRect[0]-paddingRect[0])/textRect[0]*0.90;const colFontSize=fontSize*(nodeRect[1]-paddingRect[1])/textRect[1]*0.90;if(colFontSize<rowFontSize){if(colFontSize<remSize){node.style.fontSize=remSize+"px";}else{node.style.fontSize=colFontSize+"px";}}else{if(rowFontSize<remSize){node.style.fontSize=remSize+"px";}else{node.style.fontSize=rowFontSize+"px";}}}
function shuffle(array){for(let i=array.length-1;i>0;i--){const r=Math.floor(Math.random()*(i+1));const tmp=array[i];array[i]=array[r];array[r]=tmp;}
return array;}
function typable(){if(solveCount>=9){speechSynthesis.cancel();clearInterval(typeTimer);bgm.pause();playAudio(endAudio);scoring();}else{const problem=problems[solveCount];aa.textContent=problem.kuku;japaneseNode.textContent=problem.ja;const roma=problem.en.split(" ")[1];if(mode.textContent=="EASY"){loopVoice(problem.en,1);}
while(romaNode.firstChild){romaNode.removeChild(romaNode.firstChild);}
for(let i=0;i<roma.length;i++){const span=document.createElement("span");if(mode.textContent!="EASY"){span.classList.add("d-none");}
span.textContent=roma[i];romaNode.appendChild(span);}
resizeFontSize(aa);showGuide(romaNode.childNodes[0]);}}
function countdown(){typeIndex=normalCount=errorCount=solveCount=0;document.getElementById("guideSwitch").disabled=true;document.getElementById("virtualKeyboard").disabled=true;infoPanel.classList.add("d-none");playPanel.classList.add("d-none");countPanel.classList.remove("d-none");scorePanel.classList.add("d-none");counter.textContent=3;const timer=setInterval(function(){const counter=document.getElementById("counter");const colors=["skyblue","greenyellow","violet","tomato"];if(parseInt(counter.textContent)>1){const t=parseInt(counter.textContent)-1;counter.style.backgroundColor=colors[t];counter.textContent=t;}else{clearInterval(timer);document.getElementById("guideSwitch").disabled=false;document.getElementById("virtualKeyboard").disabled=false;infoPanel.classList.remove("d-none");playPanel.classList.remove("d-none");countPanel.classList.add("d-none");scorePanel.classList.add("d-none");aa.parentNode.style.height=calcAAOuterSize()+"px";resizeFontSize(aa);window.scrollTo({top:document.getElementById("timePanel").getBoundingClientRect().top+
document.documentElement.scrollTop,behavior:"auto",});typable();startTypeTimer();if(localStorage.getItem("bgm")==1){bgm.play();}
document.addEventListener("keydown",typeEvent);}},1000);}
function startKeyEvent(event){if(event.key==" "||event.key=="Spacebar"){event.preventDefault();document.removeEventListener("keydown",startKeyEvent);replay();}}
function startTypeTimer(){const timeNode=document.getElementById("time");typeTimer=setInterval(function(){const arr=timeNode.textContent.split("Áßí /");const t=parseInt(arr[0]);if(t>0){timeNode.textContent=(t-1)+"Áßí /"+arr[1];}else{clearInterval(typeTimer);bgm.pause();playAudio(endAudio);scoring();}},1000);}
function downTime(n){const timeNode=document.getElementById("time");const arr=timeNode.textContent.split("Áßí /");const t=parseInt(arr[0]);const downedTime=t-n;if(downedTime<0){timeNode.textContent="0Áßí /"+arr[1];}else{timeNode.textContent=downedTime+"Áßí /"+arr[1];}}
function initTime(){document.getElementById("time").textContent=gameTime+"Áßí / "+gameTime+
"Áßí";}
function setProblems(){const grade=gradeOption.selectedIndex;if(grade==9){problems=allProblems.slice();problems=shuffle(problems).slice(0,10);}else{const pos=grade*9;problems=allProblems.slice(pos,pos+9);}}
gradeOption.addEventListener("change",function(){initTime();clearInterval(typeTimer);});function scoring(){infoPanel.classList.remove("d-none");playPanel.classList.add("d-none");countPanel.classList.add("d-none");scorePanel.classList.remove("d-none");document.removeEventListener("keydown",typeEvent);let time=parseInt(document.getElementById("time").textContent);if(time<gameTime){time=gameTime-time;}
const typeSpeed=(normalCount/time).toFixed(2);document.getElementById("totalType").textContent=normalCount+errorCount;document.getElementById("typeSpeed").textContent=typeSpeed;document.getElementById("errorType").textContent=errorCount;document.addEventListener("keydown",startKeyEvent);}
function changeMode(){if(this.textContent=="EASY"){this.textContent="HARD";}else{this.textContent="EASY";}}
loadProblems();aa.parentNode.style.height=calcAAOuterSize(true)+"px";resizeFontSize(aa);document.getElementById("toggleDarkMode").onclick=toggleDarkMode;document.getElementById("toggleBGM").onclick=toggleBGM;document.getElementById("virtualKeyboard").onclick=toggleKeyboard;window.addEventListener("resize",function(){aa.parentNode.style.height=calcAAOuterSize()+"px";resizeFontSize(aa);});document.getElementById("mode").onclick=changeMode;document.getElementById("guideSwitch").onchange=toggleGuide;startButton.addEventListener("click",replay);document.addEventListener("keyup",upKeyEvent);document.addEventListener("keydown",startKeyEvent);document.addEventListener("click",unlockAudio,{once:true,useCapture:true,});